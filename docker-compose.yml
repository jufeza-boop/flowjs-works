version: '3.8'

services:
  # Base de Datos Central (Configuración y Auditoría)
  # Usamos una sola instancia con dos bases de datos para simplificar el MVP
  postgres:
    image: postgres:15-alpine
    container_name: flowjs-db
    restart: always
    environment:
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=flowjs_pass
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db:/docker-entrypoint-initdb.d # Para crear las DBs al iniciar

  # Bus de Mensajes Interno para Auditoría
  nats:
    image: nats:2.9-alpine
    container_name: flowjs-bus
    ports:
      - "4222:4222" # Client port
      - "8222:8222" # HTTP Monitoring port

  # Audit Logger: consumes NATS audit.logs and persists to PostgreSQL
  audit-logger:
    build:
      context: ./services/audit-logger
      dockerfile: Dockerfile
    container_name: flowjs-audit-logger
    restart: always
    environment:
      - NATS_URL=nats://nats:4222
      - POSTGRES_DSN=host=postgres port=5432 user=admin password=flowjs_pass dbname=flowjs_audit sslmode=disable
      - HTTP_ADDR=:8080
    ports:
      - "8080:8080"
    depends_on:
      - postgres
      - nats

  # Engine HTTP Server: executes DSL flows sent from the Designer UI
  engine:
    build:
      context: ./services/engine
      dockerfile: Dockerfile
    container_name: flowjs-engine
    restart: always
    environment:
      - NATS_URL=nats://nats:4222
      - HTTP_ADDR=:9090
    ports:
      - "9090:9090"
    depends_on:
      - nats

  # UI de gestión de base de datos (Opcional, muy útil para debug)
  pgadmin:
    image: dpage/pgadmin4
    container_name: flowjs-pgadmin
    environment:
      - PGADMIN_DEFAULT_EMAIL=admin@flowjs.com
      - PGADMIN_DEFAULT_PASSWORD=admin
    ports:
      - "5050:80"
    depends_on:
      - postgres

volumes:
  postgres_data: